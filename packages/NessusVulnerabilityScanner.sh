#!/bin/bash
set -e

# Run this Script with "sudo"

figlet -f slant "Nessus Vulnerability Scanner"
LOG="/var/log/NessusVulnerabilityScanner.log"

# Function to check if a command exists
command_exists() {
  command -v "$1" &>/dev/null
}

echo "[Nessus]{INFO} --> Checking for Docker..." | tee -a $LOG
if command_exists docker; then
  echo "[Nessus]{NOTE} --> Docker is already installed." | tee -a $LOG
else
  echo "[Nessus]{INFO} --> Installing Docker..." | tee -a $LOG
  apt update
  apt install -y apt-transport-https ca-certificates curl software-properties-common
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
  add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
  apt update
  apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  echo "[Nessus]{NOTE} --> Docker installation complete." | tee -a $LOG
fi

echo "[Nessus]{INFO} --> Checking Docker service status..." | tee -a $LOG
systemctl start docker
systemctl enable docker
systemctl --no-pager status docker

echo "[Nessus]{NOTE} --> Pulling Tenable Nessus Docker image..." | tee -a $LOG
docker pull tenable/nessus:latest-ubuntu

echo "#############################################################"
echo "         Generate Linking Key on this website                "
echo " https://www.tenable.com/products/nessus/nessus-essentials   "
echo "#############################################################"

read -p "[Nessus]{NOTE} Enter Tenable Linking Key: " LINKING_KEY | tee -a $LOG

if docker ps -a --format '{{.Names}}' | grep -qw "nessus-managed"; then
  echo "[Nessus]{INFO} --> Container 'nessus-managed' already exists. Starting it..." | tee -a $LOG
  docker stop nessus-managed
  docker rm nessus-managed
else
  echo "[Nessus]{INFO} --> Running Nessus Docker container..." | tee -a $LOG
  docker run --name "nessus-managed" -d \
    -p 8834:8834 \
    -e LINKING_KEY="$LINKING_KEY" \
    -e USERNAME="admin" \
    -e PASSWORD="admin123" \
    -e MANAGER_HOST=cloud.tenable.com \
    -e MANAGER_PORT=443 \
    tenable/nessus:latest-ubuntu
fi

echo "[Nessus]{NOTE} --> Nessus container 'nessus-managed' is running on port 8834." | tee -a $LOG

echo "#########################################################"  | tee -a $LOG
echo " Nessus is available on https://localhost:8834 "            | tee -a $LOG  
echo " NOTE: Initial setup may take several minutes to complete." | tee -a $LOG
echo " Wait unitl the plugin & Data Base are Updated "            | tee -a $LOG  
echo " Check README file for Login Credentials       "            | tee -a $LOG
echo "#########################################################"  | tee -a $LOG

